<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="../scss/main/nav/css/nav.css" />
    <link rel="stylesheet" href="../scss/global/css/Styles.css" />
    <link rel="stylesheet" href="../scss/booking/css/Styles.css" />
  </head>
  <body>
    <script src="../utils/tokenDecoder.js"></script>
    <nav>
      <div class="logo">
        <img src="../Asserts/Nav/logo.svg" alt="Company Logo" />
        <div class="title">Train</div>
      </div>
      <div class="menu">
        <div class="customer" onclick="checkbalance()">
          <img src="../Asserts/Nav/customer.svg" alt="Customer Service" />
          <div class="title">Balance</div>
        </div>
        <div class="tickets">
          <img src="../Asserts/Nav/tickets.svg" alt="Tickets" />
          <div class="title" onclick="window.location.href = 'tickets.html'">
            My Tickets
          </div>
        </div>
        <div class="auth">
          <img src="../Asserts/Nav/user.svg" alt="User" />
          <div
            class="title"
            onclick="document.cookie = 'railways-token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;'; window.location.href = 'login.html'"
          >
            Logout
          </div>
        </div>
      </div>
    </nav>
    <main>
      <div class="menu">
        <div class="title">Booking Details</div>
        <div class="details">
          <div class="from">VN -></div>
          <div class="to">MAS</div>
          <div class="date">Fri, 28Jun</div>
        </div>
      </div>
      <div class="booking-details">
        <div class="booking-container">
          <div class="train-details">
            <div class="title">BOOKING DETAILS</div>
            <div class="card">
              <div class="train-type">
                <div class="type">CC General Quota</div>
                <div class="available-seats">AVL 43</div>
              </div>
              <div class="train-timing">
                <div class="train-details">
                  <div class="date">Fri, 28 Jun</div>
                  <div class="number">12345</div>
                  <div class="name"></div>
                </div>
                <div class="timing-details">
                  <div class="from">
                    <div class="station-timing">05:17</div>
                    <div class="station-name"></div>
                  </div>
                  <div class="duration">
                    <div class="duration-time">1h 30m</div>
                    <div class="duration-line"></div>
                  </div>
                  <div class="to">
                    <div class="station-timing">06:47</div>
                    <div class="station-name"></div>
                  </div>
                </div>
              </div>
              <div class="line"></div>
              <div class="boarding-details">
                <div class="title">Boarding Station</div>
                <div class="station-details">
                  <div class="station-name"></div>
                  <div class="station-code"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="Passenger-details">
          <div class="title">PASSENGER DETAILS</div>
          <div class="passengerList"></div>
          <button
            type="button"
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#staticBackdrop"
          >
            Add passengers
          </button>
        </div>
      </div>
      <div class="payment">
        <button onclick="payment()">PAY</button>
      </div>
    </main>
    <div
      class="modal fade"
      id="staticBackdrop"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">
              Add Passenger
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="passengerForm">
              <div class="form-group">
                <label for="name">Name</label>
                <input type="text" class="form-control" name="name" id="name" />
              </div>
              <div class="form-group">
                <label for="age">Age</label>
                <input type="number" class="form-control" name="age" id="age" />
              </div>
              <div class="form-group">
                <label for="gender">Gender</label>
                <select class="custom-select" name="gender" id="gender">
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div class="form-group">
                <p class="form-text text-muted">
                  Note: As per the latest government rules, it is mandatory to
                  share your address.
                </p>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="addPassenger()"
            >
              Add
            </button>
          </div>
        </div>
      </div>
    </div>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script src="../js/config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.2/axios.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"
    ></script>

    <script>
      if (
        !document.cookie.split(";").some((item) => {
          const [name, value] = item.trim().split("=");
          return name === "railways-token" && value !== "" && value !== "null";
        })
      ) {
        window.location.href = "./login.html";
      }
      
      const passengers = [];

      function addPassenger() {
        const name = document.getElementById("name").value;
        const age = document.getElementById("age").value;
        const gender = document.getElementById("gender").value;

        if (name && age && gender) {
          passengers.push({ name, age });
          renderPassenger();
          document.getElementById("passengerForm").reset();
        }
      }

      function renderPassenger() {
        const passengerList = document.querySelector(".passengerList");
        passengerList.innerHTML = "";
        passengers.forEach((passenger, index) => {
          const div = document.createElement("div");
          div.classList.add("passenger");
          div.innerHTML = `
          <div class="passenger-card">
            <div class="passenger-detail">
              <div class="name">NAME: ${passenger.name}</div>
              <div class="age">AGE: ${passenger.age}</div>
            </div>
            <div class="other-options">
              <div class="delete" onclick="deletePassenger(${index})">
                <img src="../Asserts/Nav/delete.svg" alt="Delete" />
              </div>
            </div>
            </div>
          `;
          passengerList.appendChild(div);
        });
      }

      function deletePassenger(index) {
        passengers.splice(index, 1);
        renderPassenger();
      }

      document.addEventListener("DOMContentLoaded", renderPassenger);

      let stations = [];
      axios.get(`${URLS.base}/api/User/Station`).then((res) => {
        stations = res.data;
      });

      const trainId = new URLSearchParams(window.location.search).get(
        "trainId"
      );

      let train;
      axios.get(`${URLS.base}/api/User/Train/${trainId}`).then((res) => {
        train = res.data;
        const trainRoute = train.trainRoute;
        const sourceStation = findStation(trainRoute.source);
        const destinationStation = findStation(trainRoute.destination);
        document.querySelector(".train-type .available-seats").innerText =
          "AVL " + train.availableSeats;
        document.querySelector(".train-details .date").innerText =
          new Date().toLocaleDateString();
        document.querySelector(".train-details .number").innerText =
          train.trainNumber;
        document.querySelector(".train-details .name").innerText =
          train.trainName;
        document.querySelector(".train-timing .from .station-name").innerText =
          sourceStation.stationName;
        document.querySelector(".train-timing .to .station-name").innerText =
          destinationStation.stationName;
        document.querySelector(".boarding-details .station-name").innerText =
          sourceStation.stationName;
        document.querySelector(".boarding-details .station-code").innerText =
          sourceStation.stationCode;
        document.querySelector(".details .from").innerText =
          sourceStation.stationCode + " ->";
        document.querySelector(".details .to").innerText =
          destinationStation.stationCode;
        document.querySelector(".details .date").innerText =
          new Date().toLocaleDateString();
        document.querySelector(".duration .duration-time").innerText =
          trainRoute.duration + "m";
      });

      function findStation(stationId) {
        return stations.find((station) => station.stationId === stationId);
      }

      function payment() {
        const trainId = new URLSearchParams(window.location.search).get(
          "trainId"
        );
        axios
          .post(`${URLS.base}/api/User/Ticket`, {
            trainId,
            userId: userid,
            source: train.trainRoute.source,
            destination: train.trainRoute.destination,
            journeyDate: new Date().toISOString(),
            passengers: [...passengers],
          })
          .then((res) => {
            console.log(res);
          })
          .catch((err) => {
            window.location.href = "./tickets.html";
          });
      }
    </script>
  </body>
</html>
